#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

source "$ROOT_DIR/lib.sh"

install_docker() {
    if command -v docker &>/dev/null; then
        return
    fi

    curl -fsSL https://get.docker.com | sudo sh
    sudo usermod -aG docker "$USER"

    echo "Relog required for docker group to apply."
}

install_exegol() {
    if command -v exegol &>/dev/null; then
        return
    fi

    sudo apt update
    sudo apt install -y pipx
    pipx ensurepath
    pipx install exegol
}

configure_exegol_alias() {
    if grep -q "alias exegol='sudo -E" "$HOME/.zshrc" 2>/dev/null; then
        return
    fi

    echo "alias exegol='sudo -E $(echo ~/.local/bin/exegol)'" >> ~/.zshrc
    echo "âœ… Exegol alias added to ~/.zshrc (official method)"
}

install_vscode() {
    if command -v code &>/dev/null; then
        return
    fi

    sudo snap install --classic code
}

run_step docker install_docker
run_step exegol install_exegol
run_step conf_exegol configure_exegol_alias
run_step vscode install_vscode
