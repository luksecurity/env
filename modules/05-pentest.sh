#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

source "$ROOT_DIR/lib.sh"

install_docker() {
    if command -v docker &>/dev/null; then
        return
    fi

    curl -fsSL https://get.docker.com | sudo sh
    sudo usermod -aG docker "$USER"

    echo "Relog required for docker group to apply."
}

install_exegol() {
    if command -v exegol &>/dev/null; then
        return
    fi

    sudo apt update
    sudo apt install -y pipx
    pipx ensurepath
    pipx install exegol
}

configure_exegol_alias() {
    if grep -q "alias exegol='sudo -E" "$HOME/.zshrc" 2>/dev/null; then
        return
    fi

    echo "alias exegol='sudo -E $(echo ~/.local/bin/exegol)'" >> ~/.zshrc && source ~/.zshrc

    echo "âœ… Exegol alias added to ~/.zshrc (official method)"
}

install_vscode() {
    if command -v code &>/dev/null; then
        return
    fi

    sudo snap install --classic code
}

install_burp() {
    if [ -d "/opt/BurpSuitePro" ]; then
        return
    fi

    TMP_DIR=$(mktemp -d)
    cd "$TMP_DIR"

    wget -O burp.sh \
        "https://portswigger.net/burp/releases/download?product=pro&version=latest&type=Linux"

    chmod +x burp.sh
    sudo ./burp.sh -q -dir /opt/BurpSuitePro
    sudo ln -sf /opt/BurpSuitePro/BurpSuitePro /usr/local/bin/burp

    cd /
    rm -rf "$TMP_DIR"

    echo "Burp Pro installed."
    echo "License activation required at first launch."
}

run_step docker install_docker
run_step exegol install_exegol
run_step conf_exegol configure_exegol_alias
run_step vscode install_vscode
run_step burp install_burp